# Management UI Makefile
# Standard commands that work across all modules

.PHONY: help build test run clean package install dev logs ensure-build preview

# Reusable function to ensure build exists
ensure-build:
	@if [ ! -d "dist" ]; then \
		echo "ğŸ“¦ No build found. Building first..."; \
		$(MAKE) build; \
	fi

# Default target
help:
	@echo "âš¡ Management UI Commands:"
	@echo ""
	@echo "ğŸ—ï¸  Building:"
	@echo "  build       - Build the module"
	@echo "  ensure-build- Ensure build exists (build if needed)"
	@echo "  package     - Create deployable artifact"
	@echo ""
	@echo "ğŸš€ Running:"
	@echo "  dev         - Start in development mode"
	@echo "  run         - Start module locally (production)"
	@echo "  preview     - Preview production build"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  test        - Run tests"
	@echo ""
	@echo "ğŸ”§ Maintenance:"
	@echo "  install     - Install dependencies"
	@echo "  clean       - Clean build artifacts"
	@echo "  logs        - View module logs"
	@echo ""
	@echo "ğŸ—„ï¸  Backend Services:"
	@echo "  backend-up    - Start management-service and database"
	@echo "  backend-down  - Stop backend services"
	@echo "  backend-logs  - View backend service logs"
	@echo "  backend-status - Check backend service status"
	@echo "  full-dev      - Start backend services and frontend dev server"

# Build the module
build:
	@echo "ğŸ”¨ Building Management UI..."
	pnpm build

# Run tests
test:
	@echo "ğŸ§ª Running Management UI tests..."
	pnpm test

# Start module locally (production build)
run: ensure-build
	@echo "ğŸš€ Starting Management UI (production)..."
	pnpm preview

# Preview production build (alias for run)
preview: run

# Development mode with hot reload
dev:
	@echo "ğŸ”¥ Starting Management UI in development mode..."
	pnpm dev

# Create deployable artifact (same as build for frontend)
package: ensure-build
	@echo "ğŸ“¦ Packaging Management UI..."
	@echo "âœ… Build already exists or created"

# Install dependencies
install:
	@echo "ğŸ“¥ Installing Management UI dependencies..."
	pnpm install

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning Management UI..."
	rm -rf dist .output node_modules/.vite

# View module logs
logs:
	@echo "ğŸ“‹ Management UI logs..."
	@docker logs management-ui-frontend --tail=50 -f 2>/dev/null || echo "Service not running in Docker"

# Start backend services (management-service + database)
backend-up:
	@echo "ğŸš€ Starting backend services for Management UI..."
	docker-compose up -d
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	@echo "âœ… Backend services started:"
	@echo "  ğŸ“Š Management Service: http://localhost:8080"
	@echo "  ğŸ—„ï¸  PostgreSQL: localhost:5432"
	@echo "  ğŸ” Health Check: http://localhost:8080/actuator/health"

# Stop backend services
backend-down:
	@echo "ğŸ›‘ Stopping backend services..."
	docker-compose down

# View backend service logs
backend-logs:
	@echo "ğŸ“‹ Backend service logs..."
	docker-compose logs -f

# Check backend service status
backend-status:
	@echo "ğŸ“Š Backend service status..."
	@docker-compose ps
	@echo ""
	@echo "ğŸ” Health checks:"
	@curl -s http://localhost:8080/actuator/health 2>/dev/null | jq . || echo "âŒ Management Service not responding"

# Start backend services and frontend dev server
full-dev: backend-up
	@echo "ğŸ”¥ Starting full development environment..."
	@echo "â³ Waiting for backend to be fully ready..."
	@sleep 15
	@echo "ğŸš€ Starting frontend development server..."
	pnpm dev
